define(function(require, exports, module){

	var hub = require("hub");
	var ko	= require("knockout");
	ko.mapping = require("ko.mapping");

	router = Router({

		"/view" : function(){
			b_core.authorize(function( result ){
				
				setUserInfo( result );

				loadOneRow("view");

			}, function(){
				unsetUserInfo();
				
				router.setRoute("/login");
			})
		},

		"/upload" : function(){
			b_core.authorize( function(result){
				
				setUserInfo( result );

				loadOneRow("upload");

			}, function(){
				unsetUserInfo();
				router.setRoute("/login");
			})
		},

		"/login" : function(){

			loadOneRow("login");
				
		}
	})

	function setUserInfo( data ){
		if( ! G.user ){
			// name
			// realname
			// avatarurl
			G.user = ko.mapping.fromJS( data );
			G.user.avatarBG = ko.computed(function(){
				var relative = this.avatarurl() || "./user_upload/1.jpg";
				return "url(http://ecomfe.baidu.com/koala/" + relative.substr(2)+")";
			}, G.user);

			ko.applyBindings( G.user, $("#UserInfo")[0]);
		}else{
			ko.mapping.fromJS( data, G.user );
		}
	}

	function unsetUserInfo(){
		var emtpyInfo = {
			name : "",
			realname : "未登录",
			avatarurl	: "",
			avatarBG : ""
		}
		setUserInfo( emtpyInfo );
	}

	function loadOneRow( moduleName ){

		hub.publish("module:unloadfromtpl", ".column-2", function(){

			var $main = $(".column-2");
				
			$main.html( $("#template-one-row").html() );
			var $wrapper = $main.find(".wrapper");
			
			$wrapper.append( createModuleTemplate(moduleName) );
			
			hub.publish("module:loadfromtpl", ".column-2");
		})
	}

	function createModuleTemplate( moduleName ){
		var tpl = '<div class="module" data-module="'+moduleName+'" />';
		var $tpl = $(tpl);
		$tpl.attr("id", moduleName.substr(0,1).toUpperCase() + moduleName.substr(1) );
		return $tpl;
	}

	hub.subscribe("redirect", function(url){
		router.setRoute( url );
	})

	router.configure({
		on : function(){
			
		}
	})

	exports.start = function(){

		router.init( "/view" );
	}

	exports.redirect = function(url){
		router.setRoute( url );
	}
})